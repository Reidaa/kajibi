---
- name: Deploy Strapi
  hosts: vps
  become: true
  gather_facts: true
  vars:
    exposed_port: "10749"
    image: "{{ repository }}/reidaa/kajibi-strapi:latest"
    repository: ghcr.io
    service_name: kajiback
    DOMAIN: kokuban.dev
  tasks:
    - name: Log into private registry and force re-authorization
      community.docker.docker_login:
        registry_url: "{{ repository }}"
        username: reidaa
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          62623038366238336437656234656165363162396635353930643463626238363861656662323665
          3531373863376535396433626638316531613830623438390a393166336439616164646434393436
          37633562313834646137636436613066396631666434663263386365313332613831356265303230
          6636303961383835650a343062373030336131613761383536393837393832326131353233663166
          35646263356434393334613265326439623732303339323738666165313939326566656335336262
          6133306463623136323065663165646539613132633063336262
        reauthorize: true

    - name: "Create a kajibi-strapi container"
      become: true
      community.docker.docker_container:
        name: "{{ service_name }}"
        image: "{{ image }}"
        state: "started"
        published_ports:
          - "{{ exposed_port }}:1337"
        detach: true
        recreate: true
        restart: true
        restart_policy: unless-stopped
        env:
          HOST: "0.0.0.0"
          PORT: "1337"

          # Secrets
          APP_KEYS: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            37636332636631303034643263383935333435623538663666653039616131363130663235363266
            6337383764393835306365613635613262306364383666650a663436663833646335643466346436
            33343134303937326631643365363037666430376464633364623765303061366438333035333064
            3864616138326232650a306339353133346438366631393038626665376136636161366331653165
            61333462323065303466626163643635303065656661303932353763386564623764633665393763
            66656438623063653832323463633433323335336163333332313237323161333736346232663735
            66333266636663633338396336353835656531633334393863393937666635663063633035633135
            30336234666531356234363461653731656336336633343333316162396139643933623134353265
            38363261643261656534393234316165323237646661646439326364333431386261
          API_TOKEN_SALT: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            36633931346335393633333965653630666462363363393530373062393337323765363362626265
            3337383662396265663463353539663239346439636130370a613366313230373566376436366364
            39653635343862376236656465663938633339393333303864313665663237353731393339316134
            3561343661623138620a663337396466386438333435356133383935666338643536333265393031
            62303833323565623934336363366262303063343833333961343637333136666233
          ADMIN_JWT_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            34383031613135613263306438316365623666656561356161333066626433316233303730333938
            6233333539336436643765383965316265643062306633660a643534653838323131363762623834
            32313532656563643138366131653031303866313666666536313363346462613066313435373137
            3631323636353133380a393161376630663236303733613335656132313535613731613862326236
            35353535396330643532393534386337613932393962393065353661396532353764
          TRANSFER_TOKEN_SALT: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            65343466313433613832616232623834353333356237373862376663343161363363646630366566
            6237623432376231396461346162326433336331646432640a653837336334643763643336623466
            34656261626237336264313361626536333535343739613265343464383262666432616437373835
            6131396138636231300a626234373261353832376261326363323864393634303339613438656336
            39393262306136663534616431633135653735383166653430343431643839626133
          # Database
          DATABASE_CLIENT: postgres
          DATABASE_HOST: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            64336638626333373563666637356361613332623166366637326362383564353862363534303161
            3838316361326137343863666366393236313562386430320a663432376133343737613863666437
            35376262353261643433303162373339363365376262386463363534356137626532386437376466
            3866323564323338650a303133313337616330313661336530626231336562633535323336336239
            36663239653334613139396638383837313033343462653362333239616264663233666330343664
            66646639623831323636323637656336333862616437333937396433646465303934636139633935
            373265643335386461616135663738396334
          DATABASE_PORT: "5432"
          DATABASE_NAME: strapi
          DATABASE_USERNAME: neondb_owner
          DATABASE_PASSWORD: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            37313166333337343665613538393734633135363466643166356430666466643862666639366563
            3330336231373635376336386133663436623566336537660a376237323365613566643835636664
            63656136626531316634613836376631373830306333333265336335326431376334353162396238
            6466626663626237380a383230633861363866383736316239313837613935313935333430643266
            6663
          DATABASE_SSL: "true"
          JWT_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            34633764623764656164623165383935326239623235643932393365323364643835653431366632
            3132656537616637353238653236383933613963336562370a396632633239636164366334396263
            65643937316637386238373962643539393133613032316663366166323035356462376566366331
            3166306636363935380a383238316361663464633833333062373036383866653634633363356261
            33333534643463396361353839613432626236326131643839623835316666363231
        security_opts:
          - "no-new-privileges:true"
        labels:
          traefik.enable: "true"
          traefik.http.routers.kajiback.rule: Host(`{{ service_name }}.{{ DOMAIN }}`)
          traefik.http.routers.kajiback.entrypoints: "websecure"
